<script>
  import { onMount } from "svelte";
  import { cubicOut } from "svelte/easing";

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å backend ‡πÄ‡∏™‡∏£‡πá‡∏à)
  let recipientName = "‡∏û‡∏µ‡πà‡∏î‡∏≤‡∏ß";
  let senderName = "‡∏Ç‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå";
  let letterMessage =
    "‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å‡∏ú‡∏°‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏û‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏à‡∏≤‡∏Å‡πÉ‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏ú‡∏°‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡∏ã‡∏≤‡∏ö‡∏ã‡∏∂‡πâ‡∏á‡∏°‡∏≤‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡∏ú‡∏°‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡πÄ‡∏•‡∏¢ ‡πÅ‡∏ï‡πà‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏°‡∏Ñ‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏¢‡∏≠‡∏∞ ‡∏ú‡∏°‡πÄ‡∏≠‡∏á‡∏Å‡πá‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Ñ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏Ñ‡∏≠‡∏¢‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ú‡∏°‡∏Ñ‡∏á‡∏•‡∏≥‡∏ö‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏≠‡∏¢‡∏≤‡∏Å‡∏ö‡∏≠‡∏Å‡∏û‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÑ‡∏ß‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏ó‡∏µ‡πà‡∏ú‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏ú‡∏°‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏µ‡∏ô‡∏µ‡πâ ‡∏Ç‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç‡∏°‡∏≤‡∏Å‡πÜ ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÜ‡∏ß‡∏±‡∏ô ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏´‡∏ß‡∏±‡∏á‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÑ‡∏ß‡πâ ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á ‡∏¢‡∏¥‡πâ‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏î‡πÉ‡∏™‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ê‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡πà‡∏ô‡∏Ñ‡∏á ‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üíõ‚ú®";

  let isLoadingLetter = true;
  let isEnvelopeOpened = false;

  // transition ‡∏£‡∏ß‡∏° fade + fly
  function fadeFly(node, { delay = 0, y = 14, duration = 400 } = {}) {
    return {
      delay,
      duration,
      easing: cubicOut,
      css: (t) => `
        opacity: ${t};
        transform: translateY(${(1 - t) * y}px);
      `,
    };
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏≤‡∏Å backend
  onMount(async () => {
    try {
      const response = await fetch("http://localhost:3000/api/letter");
      if (response.ok) {
        const data = await response.json();
        recipientName = data.recipientName ?? recipientName;
        senderName = data.senderName ?? senderName;
        letterMessage = data.letterMessage ?? letterMessage;
      }
    } catch (error) {
      console.error("‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", error);
      // ‡∏ñ‡πâ‡∏≤ error ‡∏Å‡πá‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° default ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ
    } finally {
      isLoadingLetter = false;
    }
  });

  function toggleEnvelope() {
    isEnvelopeOpened = !isEnvelopeOpened;
  }
</script>

<main class="page">
  <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏∞‡πÄ‡∏•‡∏¢‡∏≤‡∏°‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å -->
  <div class="sea-bg">
    <div class="sea-gradient"></div>
    <div class="sea-wave wave-1"></div>
    <div class="sea-wave wave-2"></div>
  </div>

  <section class="layout">
    <header class="top-bar">
      <div class="brand">
        <div class="brand-mark">
          <img src="/Me.jpg" alt="profile" />
        </div>
        <div class="brand-text">
          <span class="brand-name">This letter is sending to P'Dao</span>
          <span class="brand-tagline">By Sukhum (Khumsup)</span>
        </div>
      </div>

      <div class="chip">28 Nov 2025</div>
    </header>

    <section class="content">
      <!-- ‡∏ù‡∏±‡πà‡∏á‡∏ã‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢ -->
      <div class="left">
        <p class="intro">
          ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡πÄ‡∏•‡πá‡∏Å‡πÜ‡∏ô‡πâ‡∏≠‡∏¢‡πÜ‡∏°‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö<br />
          <span class="highlight">{recipientName} !! </span>
        </p>

        <div
          class="envelope-wrapper {isEnvelopeOpened ? 'opened' : ''}"
          role="button"
          tabindex="0"
          aria-pressed={isEnvelopeOpened}
          on:click={toggleEnvelope}
          on:keydown={(e) => {
            if (
              e.key === "Enter" ||
              e.key === " " ||
              e.key === "Spacebar" ||
              e.key === "Space"
            ) {
              e.preventDefault();
              toggleEnvelope();
            }
          }}
        >
          <div class="envelope">
            <div class="envelope-back"></div>
            <div class="envelope-flap"></div>
            <div class="envelope-front"></div>

            <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô -->
            <div class="letter">
              <div class="letter-inner">
                <h2>‡∏ñ‡∏∂‡∏á {recipientName}</h2>

                {#if isLoadingLetter}
                  <p class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡∏•‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏û‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏≤‡∏´‡∏≤‡∏≠‡∏¢‡∏π‡πà...</p>
                {:else}
                  <p
                    class="letter-message"
                    transition:fadeFly={{ y: 18, duration: 450 }}
                  >
                    {letterMessage}
                  </p>
                {/if}

                <p class="signature">
                  ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡πà‡∏ß‡∏á‡πÉ‡∏¢‡∏à‡∏≤‡∏Å<br />
                  <span>{senderName}</span>
                </p>
              </div>
            </div>
          </div>

          <button class="envelope-hint">
            {#if isEnvelopeOpened}
              ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏≠‡∏ß‡∏¢‡∏û‡∏£‡∏à‡∏≤‡∏Å‡∏ú‡∏°‡πÄ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö!!
            {:else}
              ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö!!
            {/if}
          </button>
        </div>

        <div class="inputs">
          <label>
            ‡∏ñ‡∏∂‡∏á:
            <input bind:value={recipientName} placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏µ‡πà‡∏î‡∏≤‡∏ß" />
          </label>
          <label>
            ‡∏à‡∏≤‡∏Å:
            <input bind:value={senderName} placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå" />
          </label>
        </div>
      </div>

      <!-- ‡∏ù‡∏±‡πà‡∏á‡∏£‡∏π‡∏õ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å‡∏£‡∏¥‡∏°‡∏ó‡∏∞‡πÄ‡∏•‡∏¢‡∏≤‡∏°‡πÄ‡∏¢‡πá‡∏ô -->
      <div class="right">
        <div class="photo-card">
          <div class="photo-frame">
            <img
              src="/sea-clinic.jpg"
              alt="Sunset seaside clinic"
              on:error={(e) => (e.currentTarget.src = "Memory.jpg")}
              loading="lazy"
            />
          </div>
          <div class="photo-text">
            <h3>"‡∏ú‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏•‡∏∑‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥‡∏ô‡∏µ‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"</h3>
            <p>‚≠ê ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏û‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏Ñ‡∏≠‡∏¢‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏∏‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏°‡∏≤‡∏ï‡∏•‡∏≠‡∏î‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‚≠ê</p>
            <div class="badges">
              <span>#‡∏™‡∏∏‡∏Ç‡∏™‡∏±‡∏ô‡∏ï‡πå‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</span>
              <span>#HBD</span>
              <span>#Happy Birthday kub!!</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </section>
</main>

<style>
  /* ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö style.css ‡πÄ‡∏î‡∏¥‡∏°) */
  .letter-message {
    font-size: 0.92rem;
    line-height: 1.6;
    color: #4b5563;
    white-space: pre-line;
  }
</style>
